#!/bin/bash
# Pre-commit hook for asc
# This hook runs before each commit to ensure code quality

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}âœ— Not in a git repository${NC}"
    exit 1
fi

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo -e "${GREEN}âœ“ No Go files to check${NC}"
    exit 0
fi

echo -e "${YELLOW}Checking ${#STAGED_GO_FILES[@]} Go files...${NC}"

# 1. Format check
echo "ðŸ“ Checking code formatting..."
UNFORMATTED=$(gofmt -l $STAGED_GO_FILES)
if [ -n "$UNFORMATTED" ]; then
    echo -e "${RED}âœ— The following files are not formatted:${NC}"
    echo "$UNFORMATTED"
    echo ""
    echo "Run: make fmt"
    echo "Or: gofmt -w $UNFORMATTED"
    exit 1
fi
echo -e "${GREEN}âœ“ Code formatting OK${NC}"

# 2. Go vet
echo "ðŸ”Ž Running go vet..."
if ! go vet ./... 2>&1; then
    echo -e "${RED}âœ— go vet found issues${NC}"
    echo "Fix the issues above before committing"
    exit 1
fi
echo -e "${GREEN}âœ“ go vet passed${NC}"

# 3. Run tests (only for changed packages)
echo "ðŸ§ª Running tests for changed packages..."
CHANGED_PACKAGES=$(echo "$STAGED_GO_FILES" | xargs -n1 dirname | sort -u | sed 's|^|./|' | tr '\n' ' ')
if [ -n "$CHANGED_PACKAGES" ]; then
    if ! go test -short $CHANGED_PACKAGES 2>&1; then
        echo -e "${RED}âœ— Tests failed${NC}"
        echo "Fix failing tests before committing"
        exit 1
    fi
    echo -e "${GREEN}âœ“ Tests passed${NC}"
fi

# 4. Check for common mistakes
echo "ðŸ” Checking for common mistakes..."

# Check for TODO/FIXME without issue reference
if git diff --cached | grep -E '^\+.*\b(TODO|FIXME)\b' | grep -v '#[0-9]' > /dev/null; then
    echo -e "${YELLOW}âš  Found TODO/FIXME without issue reference${NC}"
    echo "Consider adding an issue reference (e.g., TODO(#123): ...)"
    # This is a warning, not an error
fi

# Check for fmt.Println (should use logger)
if echo "$STAGED_GO_FILES" | xargs grep -n 'fmt\.Println' 2>/dev/null | grep -v '_test\.go' > /dev/null; then
    echo -e "${YELLOW}âš  Found fmt.Println in non-test code${NC}"
    echo "Consider using the logger package instead"
    # This is a warning, not an error
fi

# Check for hardcoded credentials
if git diff --cached | grep -iE '^\+.*(password|secret|api[_-]?key|token).*=.*["\x27][^"\x27]{8,}["\x27]' > /dev/null; then
    echo -e "${RED}âœ— Possible hardcoded credentials detected${NC}"
    echo "Never commit credentials! Use environment variables or .env files"
    exit 1
fi

# 5. Check for large files
echo "ðŸ“¦ Checking file sizes..."
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read file; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ $size -gt 1048576 ]; then  # 1MB
            echo "$file ($size bytes)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}âš  Large files detected:${NC}"
    echo "$LARGE_FILES"
    echo "Consider if these files should be committed"
    # This is a warning, not an error
fi

# 6. Check commit message format (if available)
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(head -n1 "$COMMIT_MSG_FILE")
    if ! echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: .+'; then
        echo -e "${YELLOW}âš  Commit message doesn't follow conventional commits format${NC}"
        echo "Expected: <type>(<scope>): <subject>"
        echo "Example: feat(tui): add vaporwave theme"
        # This is a warning, not an error
    fi
fi

echo ""
echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo ""

exit 0
